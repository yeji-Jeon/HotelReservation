(function(h){"function"===typeof define&&define.amd?define(["jquery","./jquery.fmatter","./grid.grouping"],h):"object"===typeof module&&module.exports?module.exports=function(B,q){B||(B=window);void 0===q&&(q="undefined"!==typeof window?require("jquery"):require("jquery")(B));require("./grid.grouping");h(q);return q}:h(jQuery)})(function(h){function B(d,c,l){if(!(this instanceof B))return new B(d);this.aggregator=d;this.finilized=!1;this.context=c;this.pivotOptions=l}function q(d,c,l,n,m){var k=n.length,
q=function(b,a){var d=b,c=a;null==d&&(d="");null==c&&(c="");d=String(d);c=String(c);this.caseSensitive||(d=d.toUpperCase(),c=c.toUpperCase());if(d===c){if(b===a)return 0;if(void 0===b)return-1;if(void 0===a)return 1;if(null===b)return-1;if(null===a)return 1}return d<c?-1:1},g=function(b,a){b=Number(b);a=Number(a);return b===a?0:b<a?-1:1},e=function(b,a){b=Math.floor(Number(b));a=Math.floor(Number(a));return b===a?0:b<a?-1:1};this.items=[];this.indexesOfSourceData=[];this.trimByCollect=d;this.caseSensitive=
c;this.skipSort=l;this.fieldLength=k;this.fieldNames=Array(k);this.fieldSortDirection=Array(k);this.fieldCompare=Array(k);for(d=0;d<k;d++){c=n[d];this.fieldNames[d]=c[m||"dataName"];switch(c.sorttype){case "integer":case "int":this.fieldCompare[d]=e;break;case "number":case "currency":case "float":this.fieldCompare[d]=g;break;default:this.fieldCompare[d]=h.isFunction(c.compare)?c.compare:q}this.fieldSortDirection[d]="desc"===c.sortorder?-1:1}}var O=h.jgrid;B.prototype.calc=function(d,c,l,n,m){if(void 0!==
d)switch(this.result=this.result||0,d=parseFloat(d),this.aggregator){case "sum":this.result+=d;break;case "count":this.result++;break;case "avg":this.finilized?(this.count=this.count||0,this.result=(this.result*this.count+d)/(this.count+1)):(this.result+=d,this.count=this.count||0);this.count++;break;case "min":this.result=Math.min(this.result,d);break;case "max":this.result=Math.max(this.result,d);break;default:h.isFunction(this.aggregator)&&(this.result=this.aggregator.call(this.context,{previousResult:this.result,
value:d,fieldName:c,item:l,iItem:n,items:m}))}};B.prototype.getResult=function(d,c,l){if(void 0!==this.result||l)l&&void 0!==this.result&&(this.count=this.result=0),void 0===this.result||this.finilized||"avg"!==this.aggregator||(this.result/=this.count,this.finilized=!0),d[c]=this.result};q.prototype.compareVectorsEx=function(d,c){var l=this.fieldLength,h,m;for(h=0;h<l;h++)if(m=this.fieldCompare[h](d[h],c[h]),0!==m)return{index:h,result:m};return{index:-1,result:0}};q.prototype.getIndexOfDifferences=
function(d,c){return null===c||null===d?0:this.compareVectorsEx(d,c).index};q.prototype.compareVectors=function(d,c){var h=this.compareVectorsEx(d,c);return 0<(0<=h.index?this.fieldSortDirection[h.index]:1)?h.result:-h.result};q.prototype.getItem=function(d){return this.items[d]};q.prototype.getIndexLength=function(){return this.items.length};q.prototype.getIndexesOfSourceData=function(d){return this.indexesOfSourceData[d]};q.prototype.createDataIndex=function(d){var c,l=d.length,n=this.fieldLength,
m,k,q=this.fieldNames,g=this.indexesOfSourceData,e,b,a=this.items,t;for(c=0;c<l;c++){b=d[c];m=Array(n);for(e=0;e<n;e++)k=b[q[e]],void 0!==k&&("string"===typeof k&&this.trimByCollect&&(k=h.trim(k)),m[e]=k);b=0;t=a.length-1;if(0>t)a.push(m),g.push([c]);else if(k=this.compareVectors(m,a[t]),0===k)g[t].push(c);else if(1===k||this.skipSort)a.push(m),g.push([c]);else if(k=this.compareVectors(a[0],m),1===k)a.unshift(m),g.unshift([c]);else if(0===k)g[0].push(c);else for(;;){if(2>t-b){a.splice(t,0,m);g.splice(t,
0,[c]);break}e=Math.floor((b+t)/2);k=this.compareVectors(a[e],m);if(0===k){g[e].push(c);break}1===k?t=e:b=e}}};O.extend({pivotSetup:function(d,c){var l=this[0],n=h.isArray,m={},k={groupField:[],groupSummary:[],groupSummaryPos:[]},T={grouping:!0,groupingView:k},g=h.extend({totals:!1,useColSpanStyle:!1,trimByCollect:!0,skipSortByX:!1,skipSortByY:!1,caseSensitive:!1,footerTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1,defaultFormatting:!0,data:d},c||{}),e,b,a,t=d.length,F,f,x,
y,D,U,P=g.xDimension,z=g.yDimension,G=g.aggregates,M,t=g.totalText||g.totals||g.rowTotals||g.totalHeader,u,J=n(P)?P.length:0;y=n(z)?z.length:0;var p=n(G)?G.length:0,A=y-(1===p?1:0),H=[],K=[],Q=[],n=[],Y=["pivotInfos"],V=Array(p),N=Array(y),R,Z,w,W,L,I,C,r,E,S,v;b=function(a,b,c){a=new q(g.trimByCollect,g.caseSensitive,b,a);h.isFunction(c)&&(a.compareVectorsEx=c);a.createDataIndex(d);return a};var ba=function(a,b,d,c,e){var f,k;switch(a){case 1:f=z[c].totalText||"{0} {1} {2}";k="y"+e+"t"+c;break;case 2:f=
g.totalText||"{0}";k="t";break;default:f=1<p?b.label||"{0}":h.isFunction(z[c].label)?z[c].label:v.getItem(e)[c],k="y"+e}a=h.extend({},b,{name:k+(1<p?"a"+d:""),label:h.isFunction(f)?f.call(l,2===a?{aggregate:b,iAggregate:d,pivotOptions:g}:1===a?{yIndex:v.getItem(e),aggregate:b,iAggregate:d,yLevel:c,pivotOptions:g}:{yData:v.getItem(e)[c],yIndex:v.getItem(e),yLevel:c,pivotOptions:g}):O.template.apply(l,2===a?[String(f),b.aggregator,b.member,d]:[String(f),b.aggregator,b.member,v.getItem(e)[c],c])});delete a.member;
delete a.aggregator;return a};D=function(a,b,c){var d,e;for(d=0;d<p;d++)e=G[d],void 0===e.template&&void 0===e.formatter&&g.defaultFormatting&&(e.template="count"===e.aggregator?"integer":"number"),Q.push(ba(a,e,d,b,c))};R=function(a,b,d){var c,e,f,g;for(c=A-1;c>=b;c--)if(K[c]){for(e=0;e<=c;e++)E=H[e].groupHeaders,E[E.length-1].numberOfColumns+=p;F=z[c];f=F.totalHeader;g=F.headerOnTop;for(e=c+1;e<=A-1;e++)H[e].groupHeaders.push({titleText:g&&e===c+1||!g&&e===A-1?h.isFunction(f)?f.call(l,d,c):O.template.call(l,
String(f||""),d[c],c):"",startColumnName:"y"+(a-1)+"t"+c+(1===p?"":"a0"),numberOfColumns:p})}};var X=function(a){a=new B("count"===G[a].aggregator?"sum":G[a].aggregator,l,c);a.groupInfo={iRows:[],rows:[],ys:[],iYs:[]};return a},ca=function(){var a,b;for(a=A-1;0<=a;a--)if(K[a])for(null==N[a]&&(N[a]=Array(p)),b=0;b<p;b++)N[a][b]=X(b)},aa=function(a,b,c,d){var e,f=v.getIndexOfDifferences(b,c),g,h;if(null!==c)for(f=Math.max(f,0),e=A-1;e>=f;e--)g="y"+a+"t"+e+(1<p?"a"+d:""),K[e]&&void 0===C[g]&&(h=N[e][d],
h.getResult(C,g),C.pivotInfos[g]={colType:1,iA:d,a:G[d],level:e,iRows:h.groupInfo.iRows,rows:h.groupInfo.rows,ys:h.groupInfo.ys,iYs:h.groupInfo.iYs},b!==c&&(N[e][d]=X(d)))},da=function(a,b,c,e,f,g,k){var l;if(a!==b)for(b=A-1;0<=b;b--)K[b]&&(l=N[b][e],l.calc(f[c.member],c.member,f,g,d),l=l.groupInfo,0>h.inArray(k,l.iYs)&&(l.iYs.push(k),l.ys.push(a)),0>h.inArray(g,l.iRows)&&(l.iRows.push(g),l.rows.push(f)))};if(0===J||0===p)throw"xDimension or aggregates options are not set!";S=b(P,g.skipSortByX,g.compareVectorsByX);
v=b(z,g.skipSortByY,g.compareVectorsByY);c.xIndex=S;c.yIndex=v;for(b=0;b<J;b++)a=P[b],f={name:"x"+b,label:null!=a.label?h.isFunction(a.label)?a.label.call(l,a,b,g):a.label:a.dataName,frozen:g.frozenStaticCols},b<J-1&&!a.skipGrouping&&!a.additionalProperty&&(k.groupField.push(f.name),k.groupSummary.push(g.groupSummary),k.groupSummaryPos.push(g.groupSummaryPos)),f=h.extend(f,a),delete f.dataName,delete f.footerText,a.additionalProperty?Y.push(f.name):(Q.push(f),T.sortname=f.name);2>J&&(T.grouping=!1);
k.hideFirstGroupCol=!0;for(b=0;b<y;b++)F=z[b],K.push(F.totals||F.rowTotals||F.totalText||F.totalHeader?!0:!1);r=v.getItem(0);D(0,y-1,0);k=v.getIndexLength();for(f=1;f<k;f++){w=v.getItem(f);b=v.getIndexOfDifferences(w,r);for(a=A-1;a>=b;a--)K[a]&&D(1,a,f-1);r=w;D(0,y-1,f)}for(b=A-1;0<=b;b--)K[b]&&D(1,b,k-1);t&&D(2);r=v.getItem(0);for(a=0;a<A;a++)H.push({useColSpanStyle:g.useColSpanStyle,groupHeaders:[{titleText:h.isFunction(z[a].label)?z[a].label.call(l,{yData:r[a],yIndex:r,yLevel:a,pivotOptions:g}):
r[a],startColumnName:1===p?"y0":"y0a0",numberOfColumns:p}]});for(f=1;f<k;f++){w=v.getItem(f);b=v.getIndexOfDifferences(w,r);R(f,b,r);for(a=A-1;a>=b;a--)H[a].groupHeaders.push({titleText:h.isFunction(z[a].label)?z[a].label.call(l,{yData:w[a],yIndex:w,yLevel:a,pivotOptions:g}):w[a],startColumnName:"y"+f+(1===p?"":"a0"),numberOfColumns:p});for(a=0;a<b;a++)E=H[a].groupHeaders,E[E.length-1].numberOfColumns+=p;r=w}R(k,0,r);if(t)for(b=0;b<A;b++)H[b].groupHeaders.push({titleText:b<A-1?"":g.totalHeader||"",
startColumnName:"t"+(1===p?"":"a0"),numberOfColumns:p});R=S.getIndexLength();for(y=0;y<R;y++){a=S.getItem(y);D={iX:y,x:a};C={pivotInfos:D};for(b=0;b<J;b++)C["x"+b]=a[b];Z=S.getIndexesOfSourceData(y);if(t)for(a=0;a<p;a++)V[a]=X(a);r=null;ca();for(f=0;f<k;f++){w=v.getItem(f);W=v.getIndexesOfSourceData(f);for(a=0;a<p;a++){null!==r&&aa(f-1,w,r,a);L=[];for(b=0;b<W.length;b++)x=W[b],0<=h.inArray(x,Z)&&L.push(x);if(0<L.length){U=Array(L.length);I=G[a];M=new B(I.aggregator,l,c);for(x=0;x<L.length;x++)b=L[x],
e=d[b],U[x]=e,M.calc(e[I.member],I.member,e,b,d),t&&(u=V[a],u.calc(e[I.member],I.member,e,b,d),u=u.groupInfo,0>h.inArray(b,u.iYs)&&(u.iYs.push(f),u.ys.push(w)),0>h.inArray(b,u.iRows)&&(u.iRows.push(b),u.rows.push(e))),da(w,r,I,a,e,b,f);e="y"+f+(1===p?"":"a"+a);M.getResult(C,e);D[e]={colType:0,iY:f,y:w,iA:a,a:I,iRows:L,rows:U}}}r=w}if(null!==r)for(a=0;a<p;a++)aa(k-1,r,r,a);if(t)for(a=0;a<p;a++)e="t"+(1===p?"":"a"+a),u=V[a],u.getResult(C,e),u=u.groupInfo,D[e]={colType:2,iA:a,a:G[a],iRows:u.iRows,rows:u.rows,
iYs:u.iYs,ys:u.ys};n.push(C)}if(g.footerTotals||g.colTotals){t=n.length;for(b=0;b<J;b++)m["x"+b]=P[b].footerText||"";for(b=J;b<Q.length;b++){e=Q[b].name;M=new B(g.footerAggregator||"sum",l,c);for(x=0;x<t;x++)C=n[x],M.calc(C[e],e,C,x,n);M.getResult(m,e)}}c.colHeaders=H;return{colModel:Q,additionalProperties:Y,options:c,rows:n,groupOptions:T,groupHeaders:H,summary:m}},jqPivot:function(d,c,l,n){return this.each(function(){function m(){var e=g.pivotSetup.call(q,d,c),b=e.groupHeaders,a=e.summary,m=0,n;
for(n in a)a.hasOwnProperty(n)&&m++;a=0<m?!0:!1;m=e.groupOptions.groupingView;n=O.from.call(k,e.rows);var f;if(!c.skipSortByX)for(f=0;f<m.groupField.length;f++)n.orderBy(m.groupField[f],null!=l&&l.groupingView&&null!=l.groupingView.groupOrder&&"desc"===l.groupingView.groupOrder[f]?"d":"a","text","");c.data=d;g.call(q,h.extend(!0,{datastr:h.extend(n.select(),a?{userdata:e.summary}:{}),datatype:"jsonstring",footerrow:a,userDataOnFooter:a,colModel:e.colModel,additionalProperties:e.additionalProperties,
pivotOptions:e.options,viewrecords:!0,sortname:c.xDimension[0].dataName},e.groupOptions,l||{}));if(b.length)for(f=0;f<b.length;f++)b[f]&&b[f].groupHeaders.length&&g.setGroupHeaders.call(q,b[f]);c.frozenStaticCols&&g.setFrozenColumns.call(q)}var k=this,q=h(k),g=h.fn.jqGrid;"string"===typeof d?h.ajax(h.extend({url:d,dataType:"json",success:function(c){d=O.getAccessor(c,n&&n.reader?n.reader:"rows");m()}},n||{})):m()})}})});
//# sourceMappingURL=grid.pivot.map
